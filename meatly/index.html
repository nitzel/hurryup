<!DOCTYPE HTML> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>all things the meatly proto</title>
	<script type="text/javascript" src="js/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render });

// entities
var player;
// groups
var entities;
// guys standing around blocking you ... whut!
// that devil thing

const DOWNFISH   =1;
const IDEAFAIRY  =2;
const WORKSTATION=4;
const FOOD       =8;
const NINTENDO   =16;
const DUDE       =32;

var cursors;
// status
var motivation = 00;
var hunger = 0;
var ideaCount = 0;
var projectProgress = 0;

// sounds
var sndStep;
var sndEat;
var sndPlayNintendo;
var sndIdeaFairy;
var sndDownFish;
// texts
var textMotivation;
var textHunger;
var textBG0;
var textBG1;

//  The Google WebFont Loader will look for this object, so create it before loading the script.
WebFontConfig = {
    //  'active' means all requested fonts have finished loading
    //  We set a 1 second delay before calling 'createText'.
    //  For some reason if we don't the browser cannot render the text the first time it's created.
    active: function() { 
      game.time.events.add(Phaser.Timer.SECOND, function(){
        [textMotivation, textHunger, textBG0,textBG1].forEach(function(t){
          if(t)t.font = 'Londrina Solid';
        });
      }, this);},

    //  The Google Fonts we want to load (specify as many as you like in the array)
    google: {
      families: ['Londrina Solid']
    }

};

function preload() {
    //  Load the Google WebFont Loader script
    game.load.script('webfont', '//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js');

    game.load.image('sky',        'img/sky.png');
    game.load.image('star',       'img/star.png');
    game.load.spritesheet('dude', 'img/dude.png', 32, 48);
    game.load.spritesheet('meatly', 'img/meatlyjam01spritesheet.png', 512, 512);
    
    game.load.audio('step_concrete', 'snd/footstep_concrete.wav');
    game.load.audio('consume_food', 'snd/consume_food.wav');
    game.load.audio('consume_nintendo', 'snd/consume_nintendo.wav');
    game.load.audio('down_fish', 'snd/down.wav');
    game.load.audio('idea_fairy', 'snd/idea.wav');
}

function create() {
    game.world.setBounds(0,0,1600,600);


    // physics is just collision and movement
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  A simple background for our game
    var bg = game.add.sprite(0, 0, 'sky');
    bg.fixedToCamera = true;
    // create level-texts    
    textBG0 = game.add.text(32, 128, '`HEY!` welcome,\nOh, you look like you\'re `starving`!\n Have some `FOOD` and then `GO!`', { fontSize: '64px', fill: '#000'});
    colorText(textBG0);
    textBG0.rotation=-0.1;
    
    textBG1 = game.add.text(750, 280, 'Devving a game requires `motivation`\nGo ahead and `Play` some\ncool games on the `nintendo`s lying around.', { fontSize: '48px', fill: '#000'});
    colorText(textBG1);
    // create player
    {
      player = createShadowedObject(32, game.world.height - 64, undefined, 'meatly', 21, 0.3, 0.3);
      player.body.collideWorldBounds = true;
      // add animations to it
      anims = [];
      anims.push(player.obj.animations.add('left', [3, 4, 5, 6, 7, 0, 1, 2], 10, true));
      anims.push(player.obj.animations.add('right', [12, 11, 10, 9, 8, 15, 14, 13, ], 10, true));
      anims.forEach(function(anim){
        anim.enableUpdate=true;
        anim.onUpdate.add(animPlayer,this);
      });
    }
    // create entities
    {
      entities = game.add.group();
      entities.enableBody = true;
      // food items
      for (var i = 0; i < 4; i++)
      {
          var so = createShadowedObject(100+i*140,550-i*10, entities, 'meatly', 57, 0.3, 0.8);
          so.name = FOOD;
          game.add.tween(so.obj.position).to( { y: -300 }, 800, Phaser.Easing.Quadratic.InOut, true, 0, -1, true);
          game.add.tween(so.shadow.scale).to( { y: 0.9, x:0.9 }, 800, Phaser.Easing.Quadratic.InOut, true, 0, -1, true);   
      }
    
      // create nintendos
      createNintendoAt = function(x,y){
          var so = createShadowedObject(x,y, entities, 'meatly', 58, 0.3, 0.8);
          so.name = NINTENDO;
          game.add.tween(so.obj.position).to( { y: -300 }, 800, Phaser.Easing.Quadratic.InOut, true, 0, -1, true);
          game.add.tween(so.shadow.scale).to( { y: 0.9, x:0.9 }, 800, Phaser.Easing.Quadratic.InOut, true, 0, -1, true);  
      }
      createNintendoAt(1200,350);  
      createNintendoAt(1300,500);  
      createNintendoAt(1450,400);  
      createNintendoAt(1550,350);  
      
      // create ideaFaries
      for (var i = 0; i < 4; i++)
      {
          var so = createShadowedObject(1600+i*140,200, entities, 'meatly', 52, 0.3, 0.8);
          so.name = IDEAFAIRY;
          so.body.velocity.x = -100;
          game.add.tween(so.obj.position).to( { y: -300 }, 800, Phaser.Easing.Quadratic.InOut, true, 0, -1, true);
          game.add.tween(so.shadow.scale).to( { y: 0.9, x:0.9 }, 800, Phaser.Easing.Quadratic.InOut, true, 0, -1, true);   
      }
      // create downFishs
      for (var i = 0; i < 4; i++)
      {
          var so = createShadowedObject(1600+i*140,500, entities, 'meatly', 50, 0.3, 0.8);
          so.body.velocity.x = -100;
          so.name = DOWNFISH;
          game.add.tween(so.obj.position).to( { y: -300 }, 800, Phaser.Easing.Quadratic.InOut, true, 0, -1, true);
          game.add.tween(so.shadow.scale).to( { y: 0.9, x:0.9 }, 800, Phaser.Easing.Quadratic.InOut, true, 0, -1, true);   
      }
    }
    // sounds
    sndStep = game.add.audio('step_concrete');
    sndEat  = game.add.audio('consume_food');
    sndPlayNintendo  = game.add.audio('consume_nintendo');
    sndIdeaFairy = game.add.audio('idea_fairy');
    sndDownFish  = game.add.audio('down_fish');
    
    //  The score, will be in front of everything
    textHunger = game.add.text(16, 16, 'hunger: `0', { fontSize: '32px', fill: '#000'/*'#B03A00'*/ });
    textHunger.fixedToCamera = true;
    colorText(textHunger);
    textMotivation = game.add.text(16, 48, 'motivation: `0', { fontSize: '32px', fill: '#000'});
    textMotivation.fixedToCamera = true;
    colorText(textMotivation);
    
    cursors = game.input.keyboard.createCursorKeys();
    
    //let camera follow the player
    game.camera.target = player;
}

function update() {
    game.physics.arcade.overlap(player, entities, collideEntities, null, this);
        //  Reset the players velocity (movement)
    player.body.velocity.x = 0;
    player.body.velocity.y = 0;
    
    var up    = cursors.up.isDown;
    var down  = cursors.down.isDown;
    var left  = cursors.left.isDown;
    var right = cursors.right.isDown;
    
    if(left || up || down || right) { // moving
      if(left)
        player.body.velocity.x = -1;
      else if(right)
        player.body.velocity.x =  1;
      if(up)
        player.body.velocity.y = -1;
      else if(down)
        player.body.velocity.y =  1;
      player.body.velocity.normalize().multiply(400,400); // speed of 400 in every direction
    }
    
    if (left)
    {
      player.obj.animations.play('left');
    }
    else if (right || up || down)
    {
        player.obj.animations.play('right');
    }
    else
    {
        //  Stand still
        player.obj.animations.stop();
        
        if(motivation>=50)
          player.obj.frame = 19;
        else if (motivation>=25)
          player.obj.frame = 17;
        else 
          player.obj.frame = 21
    }
    
    //  Allow the player to jump if they are touching the ground.
    /*if (cursors.up.isDown && player.body.touching.none)
    {
        player.body.velocity.y = -350;
    } */
    
    game.world.setBounds(
      Math.max(game.camera.x-300, game.world.bounds.x),0,1500,600);
}

function collideEntities (player, ent) {
    if(ent.name & (DOWNFISH | IDEAFAIRY | FOOD | NINTENDO)){
      // Removes the food from the screen
      ent.kill();
    }
    switch(ent.name){
    case FOOD:
      hunger-=1;
      textHunger.text = 'hunger: ' + hunger;
      sndEat.play();
    break;
    case DOWNFISH:
      motivation-=50;
      sndDownFish.play();
    break
    case IDEAFAIRY:
      ideaCount++;
      sndIdeaFairy.play();
    break
    case NINTENDO:
      motivation+=25;
      textMotivation.text = 'motivation: ' + motivation;
      sndPlayNintendo.play();
    break
    
    }
}

function animPlayer(sprite, animation) {
  if([0,4,11,15,17,19,21].indexOf(animation.index) != -1) { // frame in array
    sndStep.play(); // play footstepsound when foot hits the ground
  }
}

function render(){
    game.debug.body(player);
    entities.forEach(function(ent){
      game.debug.body(ent);
    });
}

function colorText(phaserTextObj){
  var text = phaserTextObj.text; // deepcopy :(
  var C = false;
  var n = 0;
  for(var i = 0; i<text.length; i++){
    if(text[i]=='\n') n++;
    if(text[i]=='`'){
      text = text.substr(0,i)+text.substr(i+1);
      phaserTextObj.addColor(C?'#000':'#B03A00', i-n);
      C=!C;
      i--;
    }
  }
  phaserTextObj.text = text; // because of deepcopy we have to overwrite it again
}

function createShadowedObject(x, y, group, spritesheet, frame, compositScale, shadowScale, objScale, shadowColor){
    // default params
    x = x||0;
    y = y||0;
    group = group || undefined; // stays undefined
    spritesheet = spritesheet||'meatly';
    frame = frame || 0;
    compositScale = compositScale || 1.0;
    shadowScale = shadowScale || 1.0;
    objScale = objScale || 1.0 ;
    shadowColor = shadowColor || '0xDDEEFF';
    // create shadow
    var shadow = game.add.graphics();
    shadow.beginFill(shadowColor); 
    shadow.drawEllipse(0,0,256,128);
    shadow.endFill();
    shadow.position.x = 256
    shadow.position.y = 128
    shadow.scale.setTo(shadowScale,shadowScale);
    shadow.alpha = 0.8;
    // create obj
    var obj = game.add.sprite(0,0,spritesheet, frame); // 21 any meatly frame
    obj.pivot.x = (obj.x+obj.width)/2;
    obj.pivot.y = (obj.y+obj.height)/2;
    obj.position.x = 256;
    obj.position.y = -128;
    obj.scale.setTo(objScale,objScale);
    // create composit 
    var composit;
    if(group==undefined){
      composit = game.add.sprite(x,y,null);
      game.physics.arcade.enable(composit);
    }
    else 
      composit = group.create(x, y, null);
    
    composit.body.setSize(512,256,0,0);
    composit.pivot.position = composit.body.center;
    composit.scale.setTo(shadowScale,shadowScale);
    const RW = 256*shadowScale; // radius horizontal
    const RH = 128*shadowScale; // radius vertical
    //composit.body.setSize(SHADOW_RH*2,SHADOW_RV*2,512/2-SHADOW_RH*2,256/2-SHADOW_RH*2);
    
    x = (composit.body.width/2-RW)*compositScale;
    y = (composit.body.height/2-RH)*compositScale;
    w = RW*2;
    h = RH*2;
    composit.body.setSize(w,h,x,y);
    
    
    
    composit.addChild(shadow);
    composit.shadow = shadow;
    composit.addChild(obj);
    composit.obj = obj;
    composit.scale.setTo(compositScale,compositScale);
    // return it
    return composit;
}
</script>

</body>
</html>