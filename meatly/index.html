<!DOCTYPE HTML> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>all things the meatly proto</title>
	<script type="text/javascript" src="js/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', {preload:preload,create:create,update:update,render:render});

/*var stateLoad = function(game) {  };
stateLoad.prototype = 
{
	preload:function() {
    this.loader = game.load.spritesheet('meatly', 'img/meatlyjam01spritesheet.png', 512, 512);},
	create:function() {
    this.bg = game.add.sprite(game.world.centerX, game.world.centerY, 'meatly', 62);
    this.bg.position.x -= this.bg.width/2;
    this.bg.position.y -= this.bg.height/2+80;
    game.add.tween(this.bg.position).to( { y: 100 }, 800, Phaser.Easing.Quadratic.InOut, true, 0, -1, true);
    
    game.state.add('game', );
  },
	update:function() {
    preload();
    
    game.add.tween(this.bg).to( { alpha: 255}, 2000, Phaser.Easing.Quadratic.InOut, true, 0, 1, true).onComplete.addOnce(function(){game.state.start('game');});
    
    
    //game.state.start('game');
    
  }
}
game.state.add('stateLoad', stateLoad);
game.state.start('stateLoad');*/

// entities
var player;
// groups
var entities;
// guys standing around blocking you ... whut!
// that devil thing

const DOWNFISH   =1;
const IDEAFAIRY  =2;
const WORKSTATION=4;
const FOOD       =8;
const NINTENDO   =16;
const DUDE       =32;

const INCREASE_RATE_HUNGER = 5 // per second
const INCREASE_RATE_MOTIVATION= 5 // per second

var cursors;
// status
var motivation = 0;
var hunger = 100;
var ideaCount = 0;
var projectProgress = 0;
var projectTimeStart = 0; // change later maybe
const PROJECT_TIME = 60; // 60seconds

// sounds
var sndStep;
var sndEat;
var sndPlayNintendo;
var sndIdeaFairy;
var sndDownFish;
var sndWorkstation;
// texts
var updateFontOfTheseTexts = [];
// interface
var hud;

//  The Google WebFont Loader will look for this object, so create it before loading the script.
WebFontConfig = {
    //  'active' means all requested fonts have finished loading
    //  We set a 1 second delay before calling 'createText'.
    //  For some reason if we don't the browser cannot render the text the first time it's created.
    active: function() { 
      game.time.events.add(Phaser.Timer.SECOND, function(){
        updateFontOfTheseTexts.forEach(function(t){
          if(t)t.font = 'Londrina Solid';
        });
      }, this);},

    //  The Google Fonts we want to load (specify as many as you like in the array)
    google: {
      families: ['Londrina Solid']
    }

};

function preload() {
    //  Load the Google WebFont Loader script
    game.load.script('webfont', '//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js');
    // background and meatly-spritesheet
    game.load.image('sky',        'img/sky.png');
    game.load.spritesheet('meatly', 'img/meatlyjam01spritesheet.png', 512, 512);
    // lots of sounds. these files are so big :(
    game.load.audio('step_concrete', 'snd/footstep_concrete.wav');
    game.load.audio('consume_food', 'snd/consume_food.wav');
    game.load.audio('consume_nintendo', 'snd/consume_nintendo.wav');
    game.load.audio('down_fish', 'snd/down.wav');
    game.load.audio('idea_fairy', 'snd/idea.wav');
    game.load.audio('key_strokes', 'snd/keystrokes.wav');
}

function create() {
    game.world.setBounds(0,0,1200,600);

    // physics is just collision and movement
    game.physics.startSystem(Phaser.Physics.ARCADE);
    
    // set resume-callback to correct timer
    game.onResume.add(function(){projectTimeStart+=game.time.pauseDuration;});
    
    
    //  A simple background for our game
    var bg = game.add.sprite(0, 0, 'sky');
    bg.fixedToCamera = true;
    // create level-texts    
    
    addText(32, 128, '`HEY!` welcome,\nOh, you look like you\'re `starving`!\nHave some `FOOD` and then `GO!`', { fontSize: '64px', fill: '#000'}, -0.1);
    
    addText(750, 280, 'Devving a game requires `motivation`\nGo ahead and `Play` some\ncool games on the `nintendo`s lying around.', { fontSize: '48px', fill: '#000'});
    // create player
    {
      player = createShadowedObject(0, game.world.height - 64, undefined, 'meatly', 21, 0.3, 0.3);
      player.body.collideWorldBounds = true;
      // add animations to it
      anims = [];
      anims.push(player.obj.animations.add('left', [3, 4, 5, 6, 7, 0, 1, 2], 10, true));
      anims.push(player.obj.animations.add('right', [12, 11, 10, 9, 8, 15, 14, 13, ], 10, true));
      anims.forEach(function(anim){
        anim.enableUpdate=true;
        anim.onUpdate.add(animPlayer,this);
      });
    }
    // create entities
    {
      entities = game.add.group();
      entities.enableBody = true;
      
      createEntity = function(x,y,name,frame, scale, jumping){
          scale = scale || 0.3;
          jumping = jumping || true
          var so = createShadowedObject(x,y, entities, 'meatly', frame, scale, 0.8);
          so.name = name;
          if(jumping){
            game.add.tween(so.obj.position).to( { y: -300 }, 800, Phaser.Easing.Quadratic.InOut, true, 0, -1, true);
            game.add.tween(so.shadow.scale).to( { y: 0.9, x:0.9 }, 800, Phaser.Easing.Quadratic.InOut, true, 0, -1, true);  
          }
          return so;
      }
      // food items
      for (var i = 0; i < 4; i++)
      {
          createEntity(100+i*140,550-i*10, FOOD, 57);   
      }
      // nintendos
      createEntity(1200,350, NINTENDO, 58);  
      createEntity(1300,500, NINTENDO, 58);  
      createEntity(1450,400, NINTENDO, 58);  
      createEntity(1550,350, NINTENDO, 58);  
      
      // create ideaFaries
      for (var i = 0; i < 4; i++)
      {
          var so = createEntity(1600+i*140,200+i%2*30, IDEAFAIRY, 52, 0.1);
          so.velocity.x = -170;
      }
      // create downFishs
      for (var i = 0; i < 4; i++)
      {
          var so = createEntity(1600,100+i*100, DOWNFISH, 50, 0.5);
          so.velocity.x = -70;
      }
      // create workStations
      for (var i = 0; i < 2; i++)
      {
          var so = createEntity(1800,100+i*400, WORKSTATION, 48, 0.5, false);
      }
    }
    // sounds
    sndStep = game.add.audio('step_concrete');
    sndEat  = game.add.audio('consume_food');
    sndPlayNintendo  = game.add.audio('consume_nintendo');
    sndIdeaFairy = game.add.audio('idea_fairy');
    sndDownFish  = game.add.audio('down_fish');
    sndWorkstation  = game.add.audio('key_strokes');
    
    // setup hud
    {
      hud = game.add.sprite(256,256,'meatly', 56);
      hud.pivot.setTo(hud.width/2,hud.height/2);
      hud.motivation = game.add.sprite(0,0,'meatly', 17);
      hud.motivation.pivot.setTo(hud.motivation.width/2,hud.motivation.height/2);
      hud.motivation.scale.setTo(0.5,0.5);
      hud.motivation.position.setTo(170,200);
      hud.hunger = game.add.sprite(0,0,'meatly', 57);
      hud.hunger.pivot.setTo(hud.hunger.width/2,hud.hunger.height/2);
      hud.hunger.scale.setTo(0.4,0.4);
      hud.hunger.position.setTo(280,200);
      // proj progress bar
      hud.progress = game.add.sprite(0,0,'meatly', 63);
      hud.progress.pivot.setTo(hud.progress.width/2,hud.progress.height/2);
      hud.progress.scale.setTo(1,1);
      hud.progress.position.setTo(hud.progress.width/2,550);
      // proj star=indicator of project status on progress bar
      hud.star = game.add.sprite(0,0,'meatly', 60);
      hud.star.pivot.setTo(hud.star.width/2,hud.star.height/2);
      hud.star.scale.setTo(0.3,0.3);
      hud.star.position.setTo(hud.star.width/2,550);
      // proj boss=indicator of time left till boss comes to check project
      hud.boss = game.add.sprite(0,0,'meatly', 55);
      hud.boss.pivot.setTo(hud.boss.width/2,hud.boss.height/2);
      hud.boss.scale.setTo(0.3,0.3);
      hud.boss.position.setTo(hud.boss.width/2,550);
      
      hud.ideas = [];
      for(var i=0; i<10; i++){
        ide = game.add.sprite(0,0,'meatly', 53);
        ide.pivot.setTo(ide.width/2,ide.height/2);
        ide.scale.setTo(0.2,0.2);
        ide.position.setTo(160+i*20,370);
      
        hud.ideas.push(ide)
        hud.addChild(ide);
      }
      hud.addChild(hud.motivation);
      hud.addChild(hud.hunger);
      hud.addChild(hud.progress);
      hud.addChild(hud.star);
      hud.addChild(hud.boss);
      hud.scale.setTo(0.5,0.5);
      hud.angle = 2;
      hud.position.setTo(120,120);
      hud.fixedToCamera = true;
      hud.tween = function(){game.add.tween(hud.scale).to( {x: 0.6, y: 0.6 }, 200, Phaser.Easing.Quadratic.InOut, true, 0, 0, true);}; // for notification purpose
    }
    // input method
    cursors = game.input.keyboard.createCursorKeys();
    
    //let camera follow the player
    game.camera.target = player;
    
    projectTimeStart = game.time.time;
}

function update() {
  // update motivation and hunger
  game.time
  hunger += INCREASE_RATE_HUNGER*game.time.elapsed/1000;
  motivation += INCREASE_RATE_MOTIVATION*game.time.elapsed/1000;
  

  game.physics.arcade.overlap(player, entities, collideEntities, null, this);
      //  Reset the players velocity (movement)
  player.body.velocity.x = 0;
  player.body.velocity.y = 0;
  
  var up    = cursors.up.isDown   ;
  var down  = cursors.down.isDown ;
  var left  = cursors.left.isDown ;
  var right = cursors.right.isDown;
  
  if(left || up || down || right) { // moving
    if(left)
      player.body.velocity.x = -1;
    else if(right)
      player.body.velocity.x =  1;
    if(up)
      player.body.velocity.y = -1;
    else if(down)
      player.body.velocity.y =  1;
    player.body.velocity.normalize().multiply(600,600); // speed of 400 in every direction
  }
  
  if (left)
  {
    player.obj.animations.play('left');
  }
  else if (right || up || down)
  {
      player.obj.animations.play('right');
  }
  else
  {
      //  Stand still
      player.obj.animations.stop();
      // give it a smile or not
      player.obj.frame = getMotivationFrame();
  }
  
  updateHud();
    
  game.world.setBounds(
    Math.max(game.camera.x-300, game.world.bounds.x),0,game.world.bounds.width,game.world.bounds.height);
  checkMotivationAndHunger();
}
// called for postrendering, eg for debugging body-boxes
function render(){
    //game.debug.body(player);
    entities.forEach(function(ent){
      //game.debug.body(ent);
    });
}
// collision callback
function collideEntities (player, ent) {
  if(ent.name & (DOWNFISH | IDEAFAIRY | FOOD | NINTENDO | WORKSTATION)){
    // Removes the food from the screen
    ent.kill();
  }
  switch(ent.name){
  case FOOD:
    hunger -= 30;
    sndEat.play();
  break;
  case DOWNFISH: // todo?
    motivation-=50;
    sndDownFish.play();
  break
  case IDEAFAIRY: // todo?
    ideaCount++;
    sndIdeaFairy.play();
  break
  case NINTENDO: // todo
    motivation+=15;
    sndPlayNintendo.play();
  break
  case WORKSTATION: // todo
    if(ideaCount>0){
      projectProgress += 5;
      ideaCount--;
    }
    if(motivation>0){
      projectProgress += 5*motivation/100.0;
      motivation -= Math.min(motivation, (10+hunger)/2);
      hunger += Math.min(hunger, 5);
    } else {
      
    }
    sndWorkstation.play();
  break
  }
  
  checkMotivationAndHunger();
}
// callback for player-animation. so that we know when to make step-noises
function animPlayer(sprite, animation) {
  if([0,4,11,15,17,19,21].indexOf(animation.index) != -1) { // frame in array
    sndStep.play(); // play footstepsound when foot hits the ground
  }
}
// update player hud
function updateHud(){
  // MOTIVATION
  var newMotivationFrame = getMotivationFrame();
  if(newMotivationFrame != hud.motivation.frame){ // changed, give it a tween
    game.add.tween(hud.motivation.scale).to( {x: 0.8, y: 0.8}, 200, Phaser.Easing.Quadratic.InOut, true, 0, 0, true)
  }
  hud.motivation.frame = newMotivationFrame;
  // HUNGER
  var newHungerScale = hunger/100.0 * 0.4;
  if(!game.tweens.isTweening(hud.hunger.scale)){
    game.add.tween(hud.hunger.scale).to( {x: newHungerScale, y: newHungerScale }, 200, Phaser.Easing.Quadratic.InOut, true, 0, 0, false)
  }
  // IDEA FAIRIES
  for(var i=0; i < hud.ideas.length; i++){
    if(i<ideaCount){
      if(hud.ideas[i].alpha < 1){// not visible yet, give it a tween!
        hud.ideas[i].alpha = 1;
        game.add.tween(hud.ideas[i].scale).to( {x: 0.5, y: 0.5 }, 200, Phaser.Easing.Quadratic.InOut, true, 0, 0, true)
      }
    } else {
      if(hud.ideas[i].alpha==1){ // was visible, give it a fading tween
        game.add.tween(hud.ideas[i]).to( {alpha: 0}, 200, Phaser.Easing.Quadratic.InOut, true, 0, 0, false) 
      }
    }
  }
  // update project progress
  if(!game.tweens.isTweening(hud.star.position))
    game.add.tween(hud.star.position).to( {x: 80+projectProgress*(512-2*80)/100}, 200, Phaser.Easing.Quadratic.InOut, true, 0, 0, false)
  // update time left
  if(!game.tweens.isTweening(hud.boss.position))
    game.add.tween(hud.boss.position).to( {x: Math.max(80, 512-80-(game.time.elapsedSecondsSince(projectTimeStart))*(512-2*80.0)/PROJECT_TIME)}, 200, Phaser.Easing.Quadratic.InOut, true, 0, 0, false)
}
// color text to mealty-color whenever sth is embraced in `this`
function colorText(phaserTextObj){
  var text = phaserTextObj.text; // deepcopy :(
  var C = false;
  var n = 0;
  for(var i = 0; i<text.length; i++){
    if(text[i]=='\n') n++;
    if(text[i]=='`'){
      text = text.substr(0,i)+text.substr(i+1);
      phaserTextObj.addColor(C?'#000':'#B03A00', i-n);
      C=!C;
      i--;
    }
  }
  phaserTextObj.text = text; // because of deepcopy we have to overwrite it again
}
// create scaled object with shadow below
function createShadowedObject(x, y, group, spritesheet, frame, compositScale, shadowScale, objScale, shadowColor){
    // default params
    x = x||0;
    y = y||0;
    group = group || undefined; // stays undefined
    spritesheet = spritesheet||'meatly';
    frame = frame || 0;
    compositScale = compositScale || 1.0;
    shadowScale = shadowScale || 1.0;
    objScale = objScale || 1.0 ;
    shadowColor = shadowColor || '0xDDEEFF';
    // create shadow
    var shadow = game.add.graphics();
    shadow.beginFill(shadowColor); 
    shadow.drawEllipse(0,0,256,128);
    shadow.endFill();
    shadow.position.x = 256
    shadow.position.y = 128
    shadow.scale.setTo(shadowScale,shadowScale);
    shadow.alpha = 0.8;
    // create obj
    var obj = game.add.sprite(0,0,spritesheet, frame); // 21 any meatly frame
    obj.pivot.x = (obj.x+obj.width)/2;
    obj.pivot.y = (obj.y+obj.height)/2;
    obj.position.x = 256;
    obj.position.y = -128;
    obj.scale.setTo(objScale,objScale);
    // create composit 
    var composit;
    if(group==undefined){
      composit = game.add.sprite(x,y,null);
      game.physics.arcade.enable(composit);
    }
    else 
      composit = group.create(x, y, null);
    
    composit.body.setSize(512,256,0,0);
    composit.checkWorldBounds = true;
    composit.pivot.position = composit.body.center;
    composit.scale.setTo(shadowScale,shadowScale);
    const RW = 256*shadowScale; // radius horizontal
    const RH = 128*shadowScale; // radius vertical
    //composit.body.setSize(SHADOW_RH*2,SHADOW_RV*2,512/2-SHADOW_RH*2,256/2-SHADOW_RH*2);
    
    x = (composit.body.width/2-RW)*compositScale;
    y = (composit.body.height/2-RH)*compositScale;
    w = RW*2;
    h = RH*2;
    composit.body.setSize(w,h,x,y);
    
    
    
    composit.addChild(shadow);
    composit.shadow = shadow;
    composit.addChild(obj);
    composit.obj = obj;
    composit.scale.setTo(compositScale,compositScale);
    
    composit.velocity = new Phaser.Point(0, 0);
    composit.events.onEnterBounds.add(
      function(ent){
        ent.body.velocity = ent.velocity; 
        console.log('starting:'+ent.name);
        ent.events.onOutOfBounds.add(
          function(ent2){
            console.log('leaving:'+ent2.name);ent2.destroy();
          }
        );
      }
    );
    // return it
    return composit;
}
//insert text with our font
function addText(x,y, string, style, rotation){ 
  rotation = rotation || 0; // default value
  var text = game.add.text(x, y, string, style);
  text.font = 'Londrina Solid';
  colorText(text);
  text.rotation=rotation;
  updateFontOfTheseTexts.push(text);
  return text;
}
// depending on motivation, choose the frame to display
function getMotivationFrame(){
  //     :-|          :)                 :(
  return 17 + (motivation>=75?2:0) + (motivation<=25?4:0);
}
// keep values in range
function checkMotivationAndHunger(){
  motivation = Math.min(100, Math.max(0,motivation));
  hunger = Math.min(100, Math.max(0,hunger));
}
//entities.forEach(function(a){a.events.onEnterBounds.add(function(x){console.log(x.toString())})})
</script>

</body>
</html>
